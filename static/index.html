<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Advanced Sales Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="page">
    <div class="card section">
        <h3 class="card-title"><span class="iconify" data-icon="ant-design:upload-outlined"></span> นำเข้าไฟล์ Excel</h3>
        <div class="row">
            <a class="btn btn-ghost" href="/api/template" download>
                <span class="iconify" data-icon="ant-design:download-outlined"></span>
                ดาวน์โหลดไฟล์ตัวอย่าง
            </a>
            <input type="file" id="excelFile" accept=".xlsx,.xls" />
            <button class="btn btn-primary" onclick="uploadExcel()">อัปโหลด</button>
            <span id="uploadStatus" class="muted-text"></span>
        </div>
    </div>

    <div class="card section">
        <h3 class="card-title"><span class="iconify" data-icon="ant-design:form-outlined"></span> เพิ่มรายการขายแบบกรอกฟอร์ม</h3>
        <div class="grid-form">
            <input type="date" id="f_document_date" />
            <input type="text" id="f_invoice_no" placeholder="เลขที่บิล" />
            <input type="text" id="f_customer_code" placeholder="รหัสลูกค้า" />
            <input type="text" id="f_customer_name" placeholder="ชื่อลูกค้า" />
            <select id="f_province"></select>
            <input type="text" id="f_sales_rep_code" placeholder="รหัสพนักงานขาย" />
            <input type="text" id="f_sales_rep_name" placeholder="ชื่อพนักงาน" />
            <input type="text" id="f_sales_team" placeholder="ทีม" />
            <input type="text" id="f_product_code" placeholder="รหัสสินค้า" />
            <input type="text" id="f_product_group" placeholder="กลุ่มสินค้า" />
            <input type="text" id="f_product_name" placeholder="รายละเอียดสินค้า" />
            <input type="number" step="0.01" id="f_quantity" placeholder="จำนวน" />
            <input type="text" id="f_unit_of_measure" placeholder="หน่วยนับ" />
            <input type="number" step="0.01" id="f_unit_price" placeholder="ราคา/หน่วย" />
            <input type="number" step="0.01" id="f_discount_percent" placeholder="% ส่วนลด" />
            <input type="number" step="0.01" id="f_bill_discount_percent" placeholder="% ลดท้ายบิล" />
            <input type="number" step="0.01" id="f_unit_price_non_vat" placeholder="หน่วยละ NON VAT" />
            <input type="number" step="0.01" id="f_total_amount_non_vat" placeholder="รวมเงิน NON VAT" />
        </div>
        <div class="row row-space">
            <button class="btn btn-primary" onclick="submitTransaction()">บันทึก</button>
            <span id="formStatus" class="muted-text"></span>
        </div>
    </div>

    <div class="filter-bar">
        <h3 class="filter-title"><span class="iconify" data-icon="ant-design:filter-outlined"></span> ตัวกรอง</h3>
        <select id="selYear"></select>
        <select id="selMonth">
            <option value="All">ทุกเดือน</option>
            <option value="1">มกราคม</option>
            <option value="2">กุมภาพันธ์</option>
            <option value="3">มีนาคม</option>
            <option value="4">เมษายน</option>
            <option value="5">พฤษภาคม</option>
            <option value="6">มิถุนายน</option>
            <option value="7">กรกฎาคม</option>
            <option value="8">สิงหาคม</option>
            <option value="9">กันยายน</option>
            <option value="10">ตุลาคม</option>
            <option value="11">พฤศจิกายน</option>
            <option value="12">ธันวาคม</option>
        </select>
        <select id="selRegion"><option value="All">ทุกภาค</option></select>
        <select id="selProvince"><option value="All">ทุกจังหวัด</option></select>
        <select id="selTeam"><option value="All">ทุกทีม</option></select>
        <select id="selRep"><option value="All">พนักงานทุกคน</option></select>
        <button class="btn btn-primary" onclick="updateDashboard()">กดดูข้อมูล</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-title"><span class="iconify" data-icon="ant-design:account-book-outlined"></span> ยอดขาย (ช่วงที่เลือก)</div>
            <div class="kpi-value" id="kpi-sales-period">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title"><span class="iconify" data-icon="ant-design:line-chart-outlined"></span> ยอดขายสะสม (YTD)</div>
            <div class="kpi-value" id="kpi-sales-accum">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title"><span class="iconify" data-icon="ant-design:shop-outlined"></span> จำนวน Shop (ช่วงที่เลือก)</div>
            <div class="kpi-value" id="kpi-shop-period">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title"><span class="iconify" data-icon="ant-design:bank-outlined"></span> จำนวน Shop สะสม (YTD)</div>
            <div class="kpi-value" id="kpi-shop-accum">0</div>
        </div>
    </div>

    <div class="card section">
        <h3 class="card-title"><span class="iconify" data-icon="ant-design:bar-chart-outlined"></span> เปรียบเทียบยอดขายรายปี (Current vs Previous)</h3>
        <canvas id="compareChart" height="80"></canvas>
    </div>

    <div class="chart-row">
        <div class="card">
            <h3 class="card-title"><span class="iconify" data-icon="ant-design:trophy-outlined"></span> 10 อันดับสินค้าขายดี</h3>
            <canvas id="topProductChart"></canvas>
        </div>
        <div class="card">
            <h3 class="card-title"><span class="iconify" data-icon="ant-design:team-outlined"></span> 10 อันดับลูกค้าสูงสุด</h3>
            <canvas id="topCustomerChart"></canvas>
        </div>
    </div>
    </div>
    <script>
        // Global Chart instances
        let compareChart, topProductChart, topCustomerChart;

        // Formatter (บาท)
        const fmt = new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' });
        const numFmt = new Intl.NumberFormat('th-TH');

        function buildProvinceOptions(selectEl, provincesByRegion, includeAllLabel) {
            selectEl.innerHTML = '';
            if (includeAllLabel) {
                selectEl.add(new Option(includeAllLabel, 'All'));
            } else {
                selectEl.add(new Option('เลือกจังหวัด', ''));
            }

            Object.keys(provincesByRegion).forEach(region => {
                const group = document.createElement('optgroup');
                group.label = region;
                provincesByRegion[region].forEach(p => {
                    group.appendChild(new Option(p, p));
                });
                selectEl.appendChild(group);
            });
        }

        function updateProvinceByRegion(regionSelect, provinceSelect, provincesByRegion, includeAllLabel) {
            const region = regionSelect.value;
            if (!region || region === 'All') {
                buildProvinceOptions(provinceSelect, provincesByRegion, includeAllLabel);
                return;
            }
            provinceSelect.innerHTML = '';
            if (includeAllLabel) {
                provinceSelect.add(new Option(includeAllLabel, 'All'));
            } else {
                provinceSelect.add(new Option('เลือกจังหวัด', ''));
            }
            (provincesByRegion[region] || []).forEach(p => {
                provinceSelect.add(new Option(p, p));
            });
        }

        async function loadOptions() {
            const res = await fetch('/api/options');
            const opts = await res.json();

            const selYear = document.getElementById('selYear');
            const selTeam = document.getElementById('selTeam');
            const selRep = document.getElementById('selRep');
            const selRegion = document.getElementById('selRegion');
            const selProvince = document.getElementById('selProvince');
            const formProvince = document.getElementById('f_province');

            selYear.innerHTML = '';
            selTeam.innerHTML = '<option value="All">ทุกทีม</option>';
            selRep.innerHTML = '<option value="All">พนักงานทุกคน</option>';
            selRegion.innerHTML = '<option value="All">ทุกภาค</option>';

            opts.years.forEach(y => selYear.add(new Option(y, y)));
            opts.teams.forEach(t => selTeam.add(new Option(t, t)));
            opts.reps.forEach(r => selRep.add(new Option(r, r)));
            (opts.regions || []).forEach(r => selRegion.add(new Option(r, r)));

            buildProvinceOptions(selProvince, opts.provinces_by_region, 'ทุกจังหวัด');
            buildProvinceOptions(formProvince, opts.provinces_by_region, null);

            selRegion.onchange = () => updateProvinceByRegion(selRegion, selProvince, opts.provinces_by_region, 'ทุกจังหวัด');
        }

        async function init() {
            await loadOptions();
            updateDashboard();
        }

        async function updateDashboard() {
            const year = document.getElementById('selYear').value;
            const month = document.getElementById('selMonth').value;
            const region = document.getElementById('selRegion').value;
            const province = document.getElementById('selProvince').value;
            const team = document.getElementById('selTeam').value;
            const rep = document.getElementById('selRep').value;

            // สร้าง Query String
            const q = `?year=${year}&month=${month}&region=${region}&province=${province}&team=${team}&rep=${rep}`;

            // --- 1. Load KPI ---
            const kpi = await (await fetch(`/api/kpi${q}`)).json();
            document.getElementById('kpi-sales-period').innerText = fmt.format(kpi.sales_period);
            document.getElementById('kpi-sales-accum').innerText = fmt.format(kpi.sales_accum);
            document.getElementById('kpi-shop-period').innerText = numFmt.format(kpi.shop_period);
            document.getElementById('kpi-shop-accum').innerText = numFmt.format(kpi.shop_accum);

            // --- 2. Load Comparison Chart ---
            const compData = await (await fetch(`/api/compare_year${q}`)).json();
            renderCompareChart(compData, year);

            // --- 3. Load Ranking ---
            const rankData = await (await fetch(`/api/ranking${q}`)).json();
            renderRankingCharts(rankData);
        }

        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const status = document.getElementById('uploadStatus');
            if (!fileInput.files.length) {
                status.textContent = 'กรุณาเลือกไฟล์ก่อน';
                return;
            }

            status.textContent = 'กำลังอัปโหลด...';
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const res = await fetch('/api/upload_excel', { method: 'POST', body: formData });
            if (!res.ok) {
                const err = await res.json();
                status.textContent = err.detail || 'อัปโหลดไม่สำเร็จ';
                return;
            }

            const result = await res.json();
            status.textContent = `นำเข้า ${result.rows} แถว สำเร็จ`;
            await loadOptions();
            updateDashboard();
        }

        async function submitTransaction() {
            const status = document.getElementById('formStatus');
            const payload = {
                document_date: document.getElementById('f_document_date').value,
                invoice_no: document.getElementById('f_invoice_no').value || null,
                customer_code: document.getElementById('f_customer_code').value || null,
                customer_name: document.getElementById('f_customer_name').value || null,
                province: document.getElementById('f_province').value || null,
                sales_rep_code: document.getElementById('f_sales_rep_code').value || null,
                sales_rep_name: document.getElementById('f_sales_rep_name').value || null,
                sales_team: document.getElementById('f_sales_team').value || null,
                product_code: document.getElementById('f_product_code').value || null,
                product_group: document.getElementById('f_product_group').value || null,
                product_name: document.getElementById('f_product_name').value || null,
                quantity: Number(document.getElementById('f_quantity').value || 0),
                unit_of_measure: document.getElementById('f_unit_of_measure').value || null,
                unit_price: Number(document.getElementById('f_unit_price').value || 0),
                discount_percent: Number(document.getElementById('f_discount_percent').value || 0),
                bill_discount_percent: Number(document.getElementById('f_bill_discount_percent').value || 0),
                unit_price_non_vat: Number(document.getElementById('f_unit_price_non_vat').value || 0),
                total_amount_non_vat: Number(document.getElementById('f_total_amount_non_vat').value || 0)
            };

            if (!payload.document_date) {
                status.textContent = 'กรุณาระบุวันที่';
                return;
            }

            status.textContent = 'กำลังบันทึก...';
            const res = await fetch('/api/add_transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const err = await res.json();
                status.textContent = err.detail || 'บันทึกไม่สำเร็จ';
                return;
            }

            status.textContent = 'บันทึกสำเร็จ';
            await loadOptions();
            updateDashboard();
        }

        function renderCompareChart(data, year) {
            const ctx = document.getElementById('compareChart').getContext('2d');
            if (compareChart) compareChart.destroy();

            compareChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: `ปี ${year}`,
                            data: data.current_year,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: `ปี ${year - 1}`,
                            data: data.prev_year,
                            borderColor: '#95a5a6',
                            borderDash: [5, 5], // เส้นประ
                            tension: 0.4
                        }
                    ]
                },
                options: { responsive: true, interaction: { mode: 'index', intersect: false } }
            });
        }

        function renderRankingCharts(data) {
            // Product Chart
            const ctxP = document.getElementById('topProductChart').getContext('2d');
            if (topProductChart) topProductChart.destroy();
            topProductChart = new Chart(ctxP, {
                type: 'bar',
                data: {
                    labels: data.products.map(d => d.label.substring(0, 15) + '...'), // ตัดชื่อให้สั้น
                    datasets: [{ label: 'ยอดขาย', data: data.products.map(d => d.value), backgroundColor: '#e67e22' }]
                },
                options: { indexAxis: 'y' } // กราฟแนวนอน
            });

            // Customer Chart
            const ctxC = document.getElementById('topCustomerChart').getContext('2d');
            if (topCustomerChart) topCustomerChart.destroy();
            topCustomerChart = new Chart(ctxC, {
                type: 'bar',
                data: {
                    labels: data.customers.map(d => d.label.substring(0, 15) + '...'),
                    datasets: [{ label: 'ยอดขาย', data: data.customers.map(d => d.value), backgroundColor: '#2ecc71' }]
                },
                options: { indexAxis: 'y' }
            });
        }

        init();
    </script>
</body>
</html>